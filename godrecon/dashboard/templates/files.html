{% extends "base.html" %}
{% block title %}Files ‚Äî GODRECON{% endblock %}
{% block content %}
<div class="page-header">
  <h1>üìÅ Output Files</h1>
  <p>Browse and download scan output files organized by target</p>
</div>

<div style="display:grid;grid-template-columns:280px 1fr;gap:16px;min-height:60vh;">
  <!-- Left: target list -->
  <div>
    <div class="card p-0">
      <div class="card-header" style="padding:12px 16px;">
        <div class="card-title">Targets</div>
      </div>
      <div id="targets-list" style="max-height:70vh;overflow-y:auto;">
        <div class="text-muted text-sm" style="padding:16px;"><span class="spinner"></span> Loading‚Ä¶</div>
      </div>
    </div>
  </div>

  <!-- Right: file tree + preview -->
  <div>
    <div class="card p-0" id="file-panel" style="min-height:70vh;">
      <div class="card-header" style="padding:12px 16px;display:flex;align-items:center;gap:8px;">
        <div class="card-title" id="file-panel-title">Select a target</div>
        <div style="margin-left:auto;display:flex;gap:6px;">
          <input class="filter-input" id="file-search" type="text" placeholder="Filter files‚Ä¶" style="width:180px;">
        </div>
      </div>
      <div id="file-tree" style="padding:12px 16px;max-height:60vh;overflow-y:auto;">
        <div class="text-muted text-sm">‚Üê Choose a target on the left to browse its output files.</div>
      </div>
    </div>

    <!-- Preview pane (hidden until a file is selected) -->
    <div class="card mt-3" id="preview-pane" style="display:none;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <div class="card-title" id="preview-title">Preview</div>
        <button class="btn btn-sm" id="preview-download-btn">‚¨á Download</button>
      </div>
      <pre id="preview-content" style="max-height:400px;overflow:auto;background:var(--bg-card);border:1px solid var(--border);border-radius:6px;padding:12px;font-size:12px;white-space:pre-wrap;word-break:break-all;"></pre>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
let currentTarget = null;
let allFiles = [];

async function loadTargets() {
  try {
    const data = await GODRECON.apiGet('/dashboard/api/files');
    const targets = data.targets || [];
    const list = document.getElementById('targets-list');
    if (!targets.length) {
      list.innerHTML = '<div class="text-muted text-sm" style="padding:16px;">No output directories found yet. Run a scan to generate output.</div>';
      return;
    }
    list.innerHTML = targets.map(t => `
      <div class="nav-item" style="padding:10px 16px;cursor:pointer;border-bottom:1px solid var(--border);"
           id="target-item-${CSS.escape(t.target)}"
           onclick="selectTarget('${GODRECON.escHtml(t.target)}')">
        <div style="font-weight:500;">${GODRECON.escHtml(t.target)}</div>
        <div class="text-xs text-muted">${t.status || 'unknown'} ¬∑ ${GODRECON.relativeTime(t.start_time)}</div>
      </div>
    `).join('');
  } catch(e) {
    document.getElementById('targets-list').innerHTML = '<div class="text-muted text-sm" style="padding:16px;">Failed to load targets: ' + GODRECON.escHtml(e.message) + '</div>';
  }
}

async function selectTarget(target) {
  currentTarget = target;
  document.getElementById('file-panel-title').textContent = 'üìÅ ' + target;
  document.getElementById('file-tree').innerHTML = '<div class="text-muted text-sm"><span class="spinner"></span> Loading files‚Ä¶</div>';
  document.getElementById('preview-pane').style.display = 'none';

  // Highlight selected target
  document.querySelectorAll('[id^="target-item-"]').forEach(el => el.classList.remove('active'));

  try {
    const data = await GODRECON.apiGet('/dashboard/api/files/' + encodeURIComponent(target));
    allFiles = data.files || [];
    renderFileTree(allFiles);
  } catch(e) {
    document.getElementById('file-tree').innerHTML = '<div class="text-muted text-sm">Error: ' + GODRECON.escHtml(e.message) + '</div>';
  }
}

function renderFileTree(files) {
  const tree = document.getElementById('file-tree');
  const q = document.getElementById('file-search').value.toLowerCase();
  const filtered = q ? files.filter(f => f.path.toLowerCase().includes(q)) : files;

  if (!filtered.length) {
    tree.innerHTML = '<div class="text-muted text-sm">No files found.</div>';
    return;
  }

  // Group by directory
  const dirs = {};
  filtered.forEach(f => {
    const parts = f.path.split('/');
    const dir = parts.length > 1 ? parts[0] : '';
    if (!dirs[dir]) dirs[dir] = [];
    dirs[dir].push(f);
  });

  let html = '';
  Object.entries(dirs).sort(([a],[b]) => a.localeCompare(b)).forEach(([dir, files]) => {
    if (dir) {
      html += `<div style="margin-top:8px;font-weight:600;color:var(--text-muted);font-size:11px;text-transform:uppercase;letter-spacing:.05em;">üìÇ ${GODRECON.escHtml(dir)}/</div>`;
    }
    files.sort((a,b) => a.name.localeCompare(b.name)).forEach(f => {
      const icon = f.name.endsWith('.json') ? 'üìÑ' : f.name.endsWith('.txt') ? 'üìù' : f.name.endsWith('.csv') ? 'üìä' : f.name.endsWith('.md') ? 'üì∞' : 'üìÑ';
      const size = formatSize(f.size);
      html += `
        <div class="file-item" style="display:flex;align-items:center;gap:8px;padding:6px 8px;border-radius:4px;cursor:pointer;margin:2px 0;"
             onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background=''"
             onclick="previewFile('${GODRECON.escHtml(f.path)}','${GODRECON.escHtml(f.name)}')">
          <span>${icon}</span>
          <span style="flex:1;font-size:13px;font-family:monospace;">${GODRECON.escHtml(f.name)}</span>
          <span class="text-xs text-muted">${size}</span>
          <a href="/dashboard/api/files/${encodeURIComponent(currentTarget)}/${encodeURIComponent(f.path)}/download"
             class="btn btn-xs" download="${GODRECON.escHtml(f.name)}" onclick="event.stopPropagation()">‚¨á</a>
        </div>`;
    });
  });
  tree.innerHTML = html;
}

async function previewFile(path, name) {
  const pane = document.getElementById('preview-pane');
  const content = document.getElementById('preview-content');
  const title = document.getElementById('preview-title');
  const dlBtn = document.getElementById('preview-download-btn');

  pane.style.display = 'block';
  title.textContent = name;
  content.textContent = 'Loading‚Ä¶';
  dlBtn.onclick = () => window.location.href = '/dashboard/api/files/' + encodeURIComponent(currentTarget) + '/' + encodeURIComponent(path) + '/download';

  try {
    const data = await GODRECON.apiGet('/dashboard/api/files/' + encodeURIComponent(currentTarget) + '/' + encodeURIComponent(path));
    let text = data.content || '';
    // Pretty-print JSON
    if (name.endsWith('.json')) {
      try { text = JSON.stringify(JSON.parse(text), null, 2); } catch(_) {}
    }
    content.textContent = text || '(empty file)';
  } catch(e) {
    content.textContent = 'Error loading file: ' + e.message;
  }
}

function formatSize(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
  return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

document.getElementById('file-search').addEventListener('input', GODRECON.debounce(() => {
  if (allFiles.length) renderFileTree(allFiles);
}, 200));

loadTargets();
</script>
{% endblock %}
