{% extends "base.html" %}
{% block title %}Secrets â€” GODRECON{% endblock %}
{% block content %}
<div class="page-header">
  <h1>ðŸ”‘ Secrets</h1>
  <p>Discovered secrets from js_secrets and git_dorking modules</p>
</div>
<div class="filters">
  <input class="filter-input" id="secret-search" type="text" placeholder="Search secretsâ€¦" style="flex:1;">
  <select class="filter-select" id="secret-type-filter" onchange="filterSecrets()">
    <option value="">All Types</option>
    <option value="api_key">API Key</option>
    <option value="password">Password</option>
    <option value="token">Token</option>
    <option value="private_key">Private Key</option>
    <option value="aws">AWS</option>
    <option value="github">GitHub</option>
  </select>
  <button class="btn btn-sm" onclick="GODRECON.exportTableCSV('secrets-table','secrets.csv')">â¬‡ CSV</button>
</div>
<div class="card p-0">
  <div class="table-wrap">
    <table id="secrets-table" data-sortable>
      <thead>
        <tr>
          <th class="sortable">Type</th>
          <th class="sortable">Source URL</th>
          <th>Secret (Redacted)</th>
          <th class="sortable">Module</th>
          <th class="sortable">Scan Target</th>
          <th>Validation</th>
          <th>Copy</th>
        </tr>
      </thead>
      <tbody id="secrets-tbody">
        <tr><td colspan="7" class="table-empty"><span class="spinner"></span> Loadingâ€¦</td></tr>
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
let allSecrets = [];
async function loadSecrets() {
  try {
    const scans = await GODRECON.apiGet('/api/v1/scans');
    const secrets = [];
    for (const scan of (scans.scans || [])) {
      if (scan.status !== 'completed') continue;
      try {
        const detail = await GODRECON.apiGet('/api/v1/scans/' + scan.scan_id);
        // Look in module results
        ['js_secrets','git_dorking','github_dorking','secrets'].forEach(mod => {
          const res = (detail.module_results || {})[mod];
          if (res) {
            const data = res.data || res || {};
            (data.secrets || data.findings || []).forEach(s => {
              secrets.push({ type: s.type || 'unknown', source: s.source || s.url || '', secret: s.secret || s.value || '', module: mod, target: scan.target, scan_id: scan.scan_id, validated: s.validated });
            });
          }
        });
        // Also check findings with secret category
        (detail.findings || []).filter(f => f.category === 'secrets' || f.module?.includes('secret') || f.module?.includes('dork')).forEach(f => {
          secrets.push({ type: f.category || 'secret', source: f.target || '', secret: f.title, module: f.module, target: scan.target, scan_id: scan.scan_id });
        });
      } catch(_) {}
    }
    allSecrets = secrets;
    renderSecrets(secrets);
  } catch(e) {
    document.getElementById('secrets-tbody').innerHTML = '<tr><td colspan="7" class="table-empty">No secrets found. Run a scan with js_secrets or git_dorking modules.</td></tr>';
  }
}

function renderSecrets(list) {
  const tbody = document.getElementById('secrets-tbody');
  if (!list.length) {
    tbody.innerHTML = '<tr><td colspan="7" class="table-empty text-muted">No secrets discovered yet.</td></tr>';
    return;
  }
  tbody.innerHTML = list.map(s => {
    const redacted = s.secret ? s.secret.substring(0,8) + '****' + s.secret.substring(s.secret.length-3) : 'â€”';
    const validBadge = s.validated === true ? '<span class="badge badge-success">Valid</span>' : s.validated === false ? '<span class="badge badge-info">Invalid</span>' : '<span class="badge">Unknown</span>';
    return `<tr>
      <td><span class="badge badge-purple">${GODRECON.escHtml(s.type)}</span></td>
      <td class="font-mono text-xs" style="max-width:200px;overflow:hidden;text-overflow:ellipsis;">${GODRECON.escHtml(s.source||'â€”')}</td>
      <td class="font-mono text-sm">${GODRECON.escHtml(redacted)}</td>
      <td class="text-sm">${GODRECON.escHtml(s.module||'â€”')}</td>
      <td class="text-sm"><a href="/dashboard/scans/${s.scan_id}">${GODRECON.escHtml(s.target||'â€”')}</a></td>
      <td>${validBadge}</td>
      <td><button class="copy-btn" onclick="GODRECON.copyToClipboard('${GODRECON.escHtml(s.secret||'')}')">ðŸ“‹</button></td>
    </tr>`;
  }).join('');
}

function filterSecrets() {
  const q = document.getElementById('secret-search').value.toLowerCase();
  const type = document.getElementById('secret-type-filter').value;
  const filtered = allSecrets.filter(s => {
    if (q && !JSON.stringify(s).toLowerCase().includes(q)) return false;
    if (type && !s.type.includes(type)) return false;
    return true;
  });
  renderSecrets(filtered);
}

document.getElementById('secret-search').addEventListener('input', GODRECON.debounce(filterSecrets, 200));
GODRECON.makeSortable('secrets-table');
loadSecrets();
</script>
{% endblock %}
