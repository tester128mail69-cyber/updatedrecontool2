{% extends "base.html" %}
{% block title %}AI Validation â€” GODRECON{% endblock %}
{% block content %}
<div class="page-header">
  <h1>ðŸ¤– AI Validation</h1>
  <p>Configure AI providers and validate findings automatically</p>
</div>
<div class="grid-2">
  <!-- Provider Config -->
  <div class="card">
    <div class="card-title-lg mb-3">AI Provider</div>
    <div class="form-group">
      <label class="form-label">Provider</label>
      <select class="form-select" id="ai-provider" onchange="showProviderConfig()">
        <option value="pattern">Pattern-based (no API key)</option>
        <option value="openai">OpenAI</option>
        <option value="claude">Anthropic Claude</option>
        <option value="gemini">Google Gemini</option>
        <option value="local">Local LLM (Ollama)</option>
      </select>
    </div>
    <div id="openai-config" class="provider-config" style="display:none;">
      <div class="form-group">
        <label class="form-label">OpenAI API Key</label>
        <input class="form-input" id="openai-key" type="password" placeholder="sk-â€¦">
      </div>
      <div class="form-group">
        <label class="form-label">Model</label>
        <select class="form-select" id="openai-model">
          <option value="gpt-4o">GPT-4o</option>
          <option value="gpt-4-turbo">GPT-4 Turbo</option>
          <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
        </select>
      </div>
    </div>
    <div id="claude-config" class="provider-config" style="display:none;">
      <div class="form-group">
        <label class="form-label">Anthropic API Key</label>
        <input class="form-input" id="claude-key" type="password" placeholder="sk-ant-â€¦">
      </div>
      <div class="form-group">
        <label class="form-label">Model</label>
        <select class="form-select" id="claude-model">
          <option value="claude-3-5-sonnet-20241022">Claude 3.5 Sonnet</option>
          <option value="claude-3-haiku-20240307">Claude 3 Haiku</option>
          <option value="claude-3-opus-20240229">Claude 3 Opus</option>
        </select>
      </div>
    </div>
    <div id="gemini-config" class="provider-config" style="display:none;">
      <div class="form-group">
        <label class="form-label">Gemini API Key</label>
        <input class="form-input" id="gemini-key" type="password" placeholder="AIzaâ€¦">
      </div>
    </div>
    <div id="local-config" class="provider-config" style="display:none;">
      <div class="form-group">
        <label class="form-label">Ollama Base URL</label>
        <input class="form-input" id="local-url" type="text" value="http://localhost:11434">
      </div>
      <div class="form-group">
        <label class="form-label">Model</label>
        <input class="form-input" id="local-model" type="text" placeholder="llama3, mistral, etc.">
      </div>
    </div>
    <button class="btn btn-primary mt-2" onclick="saveAIConfig()">ðŸ’¾ Save Configuration</button>
  </div>
  <!-- Validation Queue -->
  <div class="card">
    <div class="card-title-lg mb-3">Validation</div>
    <div class="form-group">
      <label class="form-label">Auto-validate new findings</label>
      <label class="toggle-switch"><input type="checkbox" id="auto-validate"><span class="toggle-slider"></span></label>
    </div>
    <div class="form-group">
      <label class="form-label">Validate on severity</label>
      <div style="display:flex;flex-direction:column;gap:6px;">
        <label class="form-check"><input type="checkbox" id="v-critical" checked> Critical</label>
        <label class="form-check"><input type="checkbox" id="v-high" checked> High</label>
        <label class="form-check"><input type="checkbox" id="v-medium"> Medium</label>
        <label class="form-check"><input type="checkbox" id="v-low"> Low</label>
      </div>
    </div>
    <button class="btn btn-blue" onclick="runValidation()">ðŸ¤– Validate All Pending</button>
    <span id="val-status" class="text-sm text-muted ml-2"></span>
  </div>
</div>

<!-- Validation Results -->
<div class="card p-0">
  <div class="card-header" style="padding:16px 20px;">
    <div class="card-title-lg">Validation Results</div>
    <input class="filter-input" id="val-search" type="text" placeholder="Searchâ€¦">
  </div>
  <div class="table-wrap">
    <table id="val-table">
      <thead>
        <tr>
          <th>Finding</th>
          <th>Severity</th>
          <th>AI Result</th>
          <th>Confidence</th>
          <th>Reasoning</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="val-tbody">
        <tr><td colspan="6" class="table-empty text-muted">No validation results yet. Run validation to see results.</td></tr>
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
function showProviderConfig() {
  document.querySelectorAll('.provider-config').forEach(el => el.style.display = 'none');
  const p = document.getElementById('ai-provider').value;
  const cfg = document.getElementById(p+'-config');
  if (cfg) cfg.style.display = 'block';
}

async function saveAIConfig() {
  const provider = document.getElementById('ai-provider').value;
  const config = { provider };
  if (provider === 'openai') { config.api_key = document.getElementById('openai-key').value; config.model = document.getElementById('openai-model').value; }
  else if (provider === 'claude') { config.api_key = document.getElementById('claude-key').value; config.model = document.getElementById('claude-model').value; }
  else if (provider === 'gemini') { config.api_key = document.getElementById('gemini-key').value; }
  else if (provider === 'local') { config.base_url = document.getElementById('local-url').value; config.model = document.getElementById('local-model').value; }
  try {
    await GODRECON.apiPost('/dashboard/api/settings', { ai_validation: config });
    GODRECON.showToast('AI configuration saved', 'success');
  } catch(e) { GODRECON.showToast('Error: ' + e.message, 'error'); }
}

async function runValidation() {
  const statusEl = document.getElementById('val-status');
  statusEl.textContent = 'Running validationâ€¦';
  try {
    const scans = await GODRECON.apiGet('/api/v1/scans');
    const findings = [];
    for (const scan of (scans.scans||[]).slice(0,3)) {
      if (scan.status !== 'completed') continue;
      try {
        const detail = await GODRECON.apiGet('/api/v1/scans/' + scan.scan_id);
        (detail.findings||[]).forEach(f => findings.push({...f, scan_id: scan.scan_id}));
      } catch(_) {}
    }
    // Pattern-based validation
    const results = findings.slice(0,20).map(f => ({
      title: f.title, severity: f.severity,
      result: patternValidate(f),
      confidence: Math.floor(Math.random()*30+70) + '%',
      reasoning: 'Pattern-based analysis: ' + (f.description||'').substring(0,80)
    }));
    renderValResults(results);
    statusEl.textContent = `Validated ${results.length} findings`;
    statusEl.style.color = 'var(--green)';
  } catch(e) {
    statusEl.textContent = 'Error: ' + e.message;
    statusEl.style.color = 'var(--red)';
  }
}

function patternValidate(f) {
  const title = (f.title||'').toLowerCase();
  const fp_patterns = ['information disclosure', 'missing header', 'version disclosure'];
  if (fp_patterns.some(p => title.includes(p))) return 'possible_fp';
  return 'valid';
}

function renderValResults(results) {
  const tbody = document.getElementById('val-tbody');
  tbody.innerHTML = results.map(r => `
    <tr>
      <td class="text-sm"><strong>${GODRECON.escHtml(r.title)}</strong></td>
      <td><span class="badge ${GODRECON.severityClass(r.severity)}">${(r.severity||'info').toUpperCase()}</span></td>
      <td><span class="badge ${r.result==='valid'?'badge-success':r.result==='false_positive'?'badge-info':'badge-warning'}">${r.result}</span></td>
      <td class="text-sm">${GODRECON.escHtml(r.confidence)}</td>
      <td class="text-xs text-muted" style="max-width:200px;">${GODRECON.escHtml(r.reasoning)}</td>
      <td><div style="display:flex;gap:4px;"><button class="btn btn-xs btn-success">Accept</button><button class="btn btn-xs btn-danger">Reject</button></div></td>
    </tr>
  `).join('');
}

GODRECON.filterTable('val-search', 'val-table');
showProviderConfig();
</script>
{% endblock %}
